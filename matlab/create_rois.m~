function create_rois(analysis_dir, acquisition_name, refMeta, varargin)
   
%  Create ROIs manually with circle-mask, save to struct:

%  Uses a single reference movie for all slices.
%  Create ROIs for each slice from the reference run/movie, then apply this
%  later to each RUN (or file) of that slice.

nargin = length(varargin);
if nargin==1
    slicesToUse = varargin{1};
else
    slicesToUse = 1:length(slice_fns);
end

M = struct();

for sidx = slicesToUse %12:2:16 %1:tiff_info.nslices
    refNum = refMeta.file(1).si.motionRefNum; % All files should have some refNum for motion correction.
    
    sliceIdxs = sidx:refMeta.file(refNum).si.nFramesPerVolume:refMeta.nTotalFrames;
    
    sliceFns = dir(fullfile(refMeta.file(refNum).si.tiffPath, '*.tif'));
    sliceFns = {sliceFns(:).name}';
    Y = tiffRead(fullfile(refMeta.file(refNum).si.tiffPath, sliceFns{sidx}));
    avgY = mean(Y, 3);

    %masks = ROIselect_circle(mat2gray(avgY));
    maskPaths = dir(fullfile(analysis_dir, 'masks_old', '*.mat'));
    maskPaths = {maskPaths(:).name}
    M.masks = masks;
    M.slice = sliceFns{sidx};
    M.refPath = refMeta.tiffPath;
    M.sliceIdxs = sliceIdxs;

    % Save reference masks:        
    struct_save_path = fullfile(analysis_dir, 'masks');
    if ~exist(struct_save_path, 'dir')
        mkdir(struct_save_path);
    end

    mask_struct_fn = char(sprintf('masks_Slice%02d_File%03d.mat', sidx, refNum));
    save(fullfile(struct_save_path, mask_struct_fn), 'M', '-struct', '-v7.3');

end

    
end
